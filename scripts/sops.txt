/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

brew install gnupg sops


export KEY_NAME="docker-desktop"
export KEY_COMMENT="flux secrets"

gpg --batch --full-generate-key <<EOF
%no-protection
Key-Type: 1
Key-Length: 4096
Subkey-Type: 1
Subkey-Length: 4096
Expire-Date: 0
Name-Comment: ${KEY_COMMENT}
Name-Real: ${KEY_NAME}
EOF


gpg --list-secret-keys "${KEY_NAME}"

gpg --delete-secret-keys "${KEY_FP}"


flux create source git fleet-infra-secrets \
--url=https://github.com/pjmagee/fleet-infra-secrets \
--branch=main

flux create kustomization fleet-infra-secrets \
--source=fleet-infra-secrets \
--path=./clusters/docker-desktop \
--prune=true \
--interval=10m \
--decryption-provider=sops \
--decryption-secret=sops-gpg



gpg --import ./clusters/docker-desktop/.sops.pub.asc


cat <<EOF > ./clusters/docker-desktop/.sops.yaml
creation_rules:
  - path_regex: .*.yaml
    encrypted_regex: ^(data|stringData)$
    pgp: ${KEY_FP}
EOF